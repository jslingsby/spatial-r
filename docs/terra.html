<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>8 Raster GIS operations in R with terra | A Minimal Introduction to GIS (in R)</title>
  <meta name="description" content="This is a minimal introduction to GIS and handling spatial data in R compiled for the Biological Sciences BSc(Honours) class at the University of Cape Town." />
  <meta name="generator" content="bookdown 0.37 and GitBook 2.6.7" />

  <meta property="og:title" content="8 Raster GIS operations in R with terra | A Minimal Introduction to GIS (in R)" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This is a minimal introduction to GIS and handling spatial data in R compiled for the Biological Sciences BSc(Honours) class at the University of Cape Town." />
  <meta name="github-repo" content="jslingsby/spatial-r" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="8 Raster GIS operations in R with terra | A Minimal Introduction to GIS (in R)" />
  
  <meta name="twitter:description" content="This is a minimal introduction to GIS and handling spatial data in R compiled for the Biological Sciences BSc(Honours) class at the University of Cape Town." />
  

<meta name="author" content="Jasper Slingsby" />


<meta name="date" content="2024-02-21" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="rdemo.html"/>
<link rel="next" href="old-raster-gis-operations-in-r-with-raster.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.2.1/leaflet.js"></script>
<script src="libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.2.1/leaflet-providers-plugin.js"></script>
<script src="libs/FlatGeoBuf-3.21.3/fgb.js"></script>
<script src="libs/FlatGeoBuf-3.21.3/flatgeobuf-geojson.min.js"></script>
<script src="libs/chromajs-2.1.0/chroma.min.js"></script>
<link id="pc-1-attachment" rel="attachment" href="libs/pc-0.0.1/pc_layer.fgb"/>
<link href="libs/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Intro to GIS in R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Overview</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#general"><i class="fa fa-check"></i><b>1.1</b> General</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#using"><i class="fa fa-check"></i><b>1.2</b> Using this resource</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#module-and-project-details"><i class="fa fa-check"></i><b>1.3</b> Module and Project details</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> Why care about GIS?</a></li>
<li class="chapter" data-level="3" data-path="gis-basics.html"><a href="gis-basics.html"><i class="fa fa-check"></i><b>3</b> GIS basics</a>
<ul>
<li class="chapter" data-level="3.1" data-path="gis-basics.html"><a href="gis-basics.html#what-is-gis"><i class="fa fa-check"></i><b>3.1</b> What is GIS?</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="gis-basics.html"><a href="gis-basics.html#an-example-workflow"><i class="fa fa-check"></i><b>3.1.1</b> An example workflow</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="gis-basics.html"><a href="gis-basics.html#how-do-we-do-gis"><i class="fa fa-check"></i><b>3.2</b> How do we do GIS?</a></li>
<li class="chapter" data-level="3.3" data-path="gis-basics.html"><a href="gis-basics.html#ucthelp"><i class="fa fa-check"></i><b>3.3</b> How to get help?</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="gis-data-models-and-file-formats.html"><a href="gis-data-models-and-file-formats.html"><i class="fa fa-check"></i><b>4</b> GIS data models and file formats</a>
<ul>
<li class="chapter" data-level="4.1" data-path="gis-data-models-and-file-formats.html"><a href="gis-data-models-and-file-formats.html#data-models"><i class="fa fa-check"></i><b>4.1</b> Data models</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="gis-data-models-and-file-formats.html"><a href="gis-data-models-and-file-formats.html#vector-data"><i class="fa fa-check"></i><b>4.1.1</b> Vector data</a></li>
<li class="chapter" data-level="4.1.2" data-path="gis-data-models-and-file-formats.html"><a href="gis-data-models-and-file-formats.html#raster-data"><i class="fa fa-check"></i><b>4.1.2</b> Raster data</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="gis-data-models-and-file-formats.html"><a href="gis-data-models-and-file-formats.html#attribute-data"><i class="fa fa-check"></i><b>4.2</b> Attribute data</a></li>
<li class="chapter" data-level="4.3" data-path="gis-data-models-and-file-formats.html"><a href="gis-data-models-and-file-formats.html#file-formats"><i class="fa fa-check"></i><b>4.3</b> File formats</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="some-important-concepts-and-pitfalls.html"><a href="some-important-concepts-and-pitfalls.html"><i class="fa fa-check"></i><b>5</b> Some important concepts and pitfalls</a>
<ul>
<li class="chapter" data-level="5.1" data-path="some-important-concepts-and-pitfalls.html"><a href="some-important-concepts-and-pitfalls.html#scale"><i class="fa fa-check"></i><b>5.1</b> Scale</a></li>
<li class="chapter" data-level="5.2" data-path="some-important-concepts-and-pitfalls.html"><a href="some-important-concepts-and-pitfalls.html#coordinate-reference-systems-crs"><i class="fa fa-check"></i><b>5.2</b> Coordinate Reference Systems (CRS)</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="some-important-concepts-and-pitfalls.html"><a href="some-important-concepts-and-pitfalls.html#geographic-or-unprojected-coordinate-systems"><i class="fa fa-check"></i><b>5.2.1</b> Geographic (or “unprojected”) Coordinate Systems</a></li>
<li class="chapter" data-level="5.2.2" data-path="some-important-concepts-and-pitfalls.html"><a href="some-important-concepts-and-pitfalls.html#projection"><i class="fa fa-check"></i><b>5.2.2</b> Projected Coordinate Systems</a></li>
<li class="chapter" data-level="5.2.3" data-path="some-important-concepts-and-pitfalls.html"><a href="some-important-concepts-and-pitfalls.html#projection-codes"><i class="fa fa-check"></i><b>5.2.3</b> Projection codes</a></li>
<li class="chapter" data-level="5.2.4" data-path="some-important-concepts-and-pitfalls.html"><a href="some-important-concepts-and-pitfalls.html#on-the-fly-vs-manual-projection"><i class="fa fa-check"></i><b>5.2.4</b> “On the fly” vs manual projection</a></li>
<li class="chapter" data-level="5.2.5" data-path="some-important-concepts-and-pitfalls.html"><a href="some-important-concepts-and-pitfalls.html#the-golden-rules"><i class="fa fa-check"></i><b>5.2.5</b> The golden rules…</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="r-as-a-gis.html"><a href="r-as-a-gis.html"><i class="fa fa-check"></i><b>6</b> R as a GIS</a>
<ul>
<li class="chapter" data-level="6.1" data-path="r-as-a-gis.html"><a href="r-as-a-gis.html#overview-1"><i class="fa fa-check"></i><b>6.1</b> Overview</a></li>
<li class="chapter" data-level="6.2" data-path="r-as-a-gis.html"><a href="r-as-a-gis.html#some-key-r-packages"><i class="fa fa-check"></i><b>6.2</b> Some key R packages</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="r-as-a-gis.html"><a href="r-as-a-gis.html#for-vector-data"><i class="fa fa-check"></i><b>6.2.1</b> For vector data</a></li>
<li class="chapter" data-level="6.2.2" data-path="r-as-a-gis.html"><a href="r-as-a-gis.html#for-raster-data"><i class="fa fa-check"></i><b>6.2.2</b> For raster data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="rdemo.html"><a href="rdemo.html"><i class="fa fa-check"></i><b>7</b> Vector GIS operations in R</a>
<ul>
<li class="chapter" data-level="7.1" data-path="rdemo.html"><a href="rdemo.html#casestudy"><i class="fa fa-check"></i><b>7.1</b> Case study and demo datasets</a></li>
<li class="chapter" data-level="7.2" data-path="rdemo.html"><a href="rdemo.html#reading-and-writing"><i class="fa fa-check"></i><b>7.2</b> Reading and writing</a></li>
<li class="chapter" data-level="7.3" data-path="rdemo.html"><a href="rdemo.html#basic-plotting"><i class="fa fa-check"></i><b>7.3</b> Basic plotting</a></li>
<li class="chapter" data-level="7.4" data-path="rdemo.html"><a href="rdemo.html#cropping"><i class="fa fa-check"></i><b>7.4</b> Cropping</a></li>
<li class="chapter" data-level="7.5" data-path="rdemo.html"><a href="rdemo.html#select-and-subset-by-attribute"><i class="fa fa-check"></i><b>7.5</b> Select and subset by attribute</a></li>
<li class="chapter" data-level="7.6" data-path="rdemo.html"><a href="rdemo.html#combine-classes-and-dissolve-by-attribute"><i class="fa fa-check"></i><b>7.6</b> Combine classes and dissolve by attribute</a></li>
<li class="chapter" data-level="7.7" data-path="rdemo.html"><a href="rdemo.html#getinat"><i class="fa fa-check"></i><b>7.7</b> Calling iNaturalist locality (point) data from R</a></li>
<li class="chapter" data-level="7.8" data-path="rdemo.html"><a href="rdemo.html#converting-a-dataframe-into-a-spatial-object"><i class="fa fa-check"></i><b>7.8</b> Converting a dataframe into a spatial object</a></li>
<li class="chapter" data-level="7.9" data-path="rdemo.html"><a href="rdemo.html#adding-basemaps-to-plots"><i class="fa fa-check"></i><b>7.9</b> Adding basemaps to plots</a></li>
<li class="chapter" data-level="7.10" data-path="rdemo.html"><a href="rdemo.html#interactive-maps-with-leaflet-and-mapview"><i class="fa fa-check"></i><b>7.10</b> Interactive maps with <em>leaflet</em> and <em>mapview</em></a></li>
<li class="chapter" data-level="7.11" data-path="rdemo.html"><a href="rdemo.html#projections"><i class="fa fa-check"></i><b>7.11</b> Reprojecting</a></li>
<li class="chapter" data-level="7.12" data-path="rdemo.html"><a href="rdemo.html#intersecting-points-and-polygons"><i class="fa fa-check"></i><b>7.12</b> Intersecting points and polygons</a></li>
<li class="chapter" data-level="7.13" data-path="rdemo.html"><a href="rdemo.html#colour-or-label-points"><i class="fa fa-check"></i><b>7.13</b> Colour or label points</a></li>
<li class="chapter" data-level="7.14" data-path="rdemo.html"><a href="rdemo.html#buffering"><i class="fa fa-check"></i><b>7.14</b> Buffering</a></li>
<li class="chapter" data-level="7.15" data-path="rdemo.html"><a href="rdemo.html#within-distance-and-intersect"><i class="fa fa-check"></i><b>7.15</b> Within distance and intersect</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="terra.html"><a href="terra.html"><i class="fa fa-check"></i><b>8</b> Raster GIS operations in R with <em>terra</em></a>
<ul>
<li class="chapter" data-level="8.1" data-path="terra.html"><a href="terra.html#reading-in-data"><i class="fa fa-check"></i><b>8.1</b> Reading in data</a></li>
<li class="chapter" data-level="8.2" data-path="terra.html"><a href="terra.html#cropping-1"><i class="fa fa-check"></i><b>8.2</b> Cropping</a></li>
<li class="chapter" data-level="8.3" data-path="terra.html"><a href="terra.html#aggregating-resampling"><i class="fa fa-check"></i><b>8.3</b> Aggregating / Resampling</a></li>
<li class="chapter" data-level="8.4" data-path="terra.html"><a href="terra.html#basic-plotting-1"><i class="fa fa-check"></i><b>8.4</b> Basic plotting</a></li>
<li class="chapter" data-level="8.5" data-path="terra.html"><a href="terra.html#disaggregating"><i class="fa fa-check"></i><b>8.5</b> Disaggregating</a></li>
<li class="chapter" data-level="8.6" data-path="terra.html"><a href="terra.html#raster-maths"><i class="fa fa-check"></i><b>8.6</b> Raster maths!</a></li>
<li class="chapter" data-level="8.7" data-path="terra.html"><a href="terra.html#focal-and-terrain-calculations"><i class="fa fa-check"></i><b>8.7</b> Focal and terrain calculations</a></li>
<li class="chapter" data-level="8.8" data-path="terra.html"><a href="terra.html#raster-stacks"><i class="fa fa-check"></i><b>8.8</b> Raster stacks</a></li>
<li class="chapter" data-level="8.9" data-path="terra.html"><a href="terra.html#extracting-raster-to-vector"><i class="fa fa-check"></i><b>8.9</b> Extracting raster to vector</a></li>
<li class="chapter" data-level="8.10" data-path="terra.html"><a href="terra.html#rasterizing"><i class="fa fa-check"></i><b>8.10</b> Rasterizing</a></li>
<li class="chapter" data-level="8.11" data-path="terra.html"><a href="terra.html#crosstabulating-rasters"><i class="fa fa-check"></i><b>8.11</b> Crosstabulating rasters</a></li>
<li class="chapter" data-level="8.12" data-path="terra.html"><a href="terra.html#visualizing-multiple-datasets-on-one-map"><i class="fa fa-check"></i><b>8.12</b> Visualizing multiple datasets on one map</a></li>
<li class="chapter" data-level="8.13" data-path="terra.html"><a href="terra.html#cloud-optimized-geotiffs-cogs"><i class="fa fa-check"></i><b>8.13</b> Cloud Optimized GeoTiffs (COGs)!!!</a></li>
<li class="chapter" data-level="8.14" data-path="terra.html"><a href="terra.html#obtaining-satellite-data-from-apis"><i class="fa fa-check"></i><b>8.14</b> Obtaining satellite data from APIs</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="old-raster-gis-operations-in-r-with-raster.html"><a href="old-raster-gis-operations-in-r-with-raster.html"><i class="fa fa-check"></i><b>9</b> (Old!) Raster GIS operations in R with <em>raster</em></a>
<ul>
<li class="chapter" data-level="9.1" data-path="old-raster-gis-operations-in-r-with-raster.html"><a href="old-raster-gis-operations-in-r-with-raster.html#reading-in-data-1"><i class="fa fa-check"></i><b>9.1</b> Reading in data</a></li>
<li class="chapter" data-level="9.2" data-path="old-raster-gis-operations-in-r-with-raster.html"><a href="old-raster-gis-operations-in-r-with-raster.html#cropping-2"><i class="fa fa-check"></i><b>9.2</b> Cropping</a></li>
<li class="chapter" data-level="9.3" data-path="old-raster-gis-operations-in-r-with-raster.html"><a href="old-raster-gis-operations-in-r-with-raster.html#aggregating-resampling-1"><i class="fa fa-check"></i><b>9.3</b> Aggregating / Resampling</a></li>
<li class="chapter" data-level="9.4" data-path="old-raster-gis-operations-in-r-with-raster.html"><a href="old-raster-gis-operations-in-r-with-raster.html#basic-plotting-2"><i class="fa fa-check"></i><b>9.4</b> Basic plotting</a></li>
<li class="chapter" data-level="9.5" data-path="old-raster-gis-operations-in-r-with-raster.html"><a href="old-raster-gis-operations-in-r-with-raster.html#disaggregating-1"><i class="fa fa-check"></i><b>9.5</b> Disaggregating</a></li>
<li class="chapter" data-level="9.6" data-path="old-raster-gis-operations-in-r-with-raster.html"><a href="old-raster-gis-operations-in-r-with-raster.html#raster-maths-1"><i class="fa fa-check"></i><b>9.6</b> Raster maths!</a></li>
<li class="chapter" data-level="9.7" data-path="old-raster-gis-operations-in-r-with-raster.html"><a href="old-raster-gis-operations-in-r-with-raster.html#focal-and-terrain-calculations-1"><i class="fa fa-check"></i><b>9.7</b> Focal and terrain calculations</a></li>
<li class="chapter" data-level="9.8" data-path="old-raster-gis-operations-in-r-with-raster.html"><a href="old-raster-gis-operations-in-r-with-raster.html#raster-stacks-1"><i class="fa fa-check"></i><b>9.8</b> Raster stacks</a></li>
<li class="chapter" data-level="9.9" data-path="old-raster-gis-operations-in-r-with-raster.html"><a href="old-raster-gis-operations-in-r-with-raster.html#extracting-raster-to-vector-1"><i class="fa fa-check"></i><b>9.9</b> Extracting raster to vector</a></li>
<li class="chapter" data-level="9.10" data-path="old-raster-gis-operations-in-r-with-raster.html"><a href="old-raster-gis-operations-in-r-with-raster.html#rasterizing-1"><i class="fa fa-check"></i><b>9.10</b> Rasterizing</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">A Minimal Introduction to GIS (in R)</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="terra" class="section level1 hasAnchor" number="8">
<h1><span class="header-section-number">8</span> Raster GIS operations in R with <em>terra</em><a href="terra.html#terra" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="reading-in-data" class="section level2 hasAnchor" number="8.1">
<h2><span class="header-section-number">8.1</span> Reading in data<a href="terra.html#reading-in-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Ok, now to look at handling rasters. As with <em>sf</em>, the <em>terra</em> package has one function -<code>rast()</code>- that can read in just about any raster file format, which it assigns it’s own class <code>SpatRaster</code>. Let’s get started and read in the digital elevation model (DEM) for the City of Cape Town.</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="terra.html#cb94-1" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb94-2"><a href="terra.html#cb94-2" tabindex="-1"></a></span>
<span id="cb94-3"><a href="terra.html#cb94-3" tabindex="-1"></a>dem <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;data/cape_peninsula/CoCT_10m.tif&quot;</span>)</span>
<span id="cb94-4"><a href="terra.html#cb94-4" tabindex="-1"></a></span>
<span id="cb94-5"><a href="terra.html#cb94-5" tabindex="-1"></a><span class="fu">class</span>(dem)</span></code></pre></div>
<pre><code>## [1] &quot;SpatRaster&quot;
## attr(,&quot;package&quot;)
## [1] &quot;terra&quot;</code></pre>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="terra.html#cb96-1" tabindex="-1"></a>dem <span class="co">#Typing the name of a &quot;SpatRaster&quot; class data object gives you the details</span></span></code></pre></div>
<pre><code>## class       : SpatRaster 
## dimensions  : 9902, 6518, 1  (nrow, ncol, nlyr)
## resolution  : 10, 10  (x, y)
## extent      : -64180, 1000, -3804020, -3705000  (xmin, xmax, ymin, ymax)
## coord. ref. : GCS_WGS_1984 
## source      : CoCT_10m.tif 
## name        : 10m_BA 
## min value   :    -35 
## max value   :   1590</code></pre>
<p>The <code>coord. ref.</code> field shows <code>GCS_WGS_1984</code>, which is Geographic Coordinates, but perhaps there is a projected CRS too? The extent appears to be in metres, with the eastings being a mix of positive and negative numbers, from which we can deduce that the coordinate reference system may be Transverse Mercator centred on Lo19, as for the other datasets we obtained from the City of Cape Town. Best to make sure! If you just want to know the CRS from a SpatRaster, you just call <code>crs()</code> like so:</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="terra.html#cb98-1" tabindex="-1"></a><span class="fu">crs</span>(dem)</span></code></pre></div>
<pre><code>## [1] &quot;PROJCRS[\&quot;GCS_WGS_1984\&quot;,\n    BASEGEOGCRS[\&quot;WGS 84\&quot;,\n        DATUM[\&quot;World Geodetic System 1984\&quot;,\n            ELLIPSOID[\&quot;WGS 84\&quot;,6378137,298.25722356049,\n                LENGTHUNIT[\&quot;metre\&quot;,1]]],\n        PRIMEM[\&quot;Greenwich\&quot;,0,\n            ANGLEUNIT[\&quot;degree\&quot;,0.0174532925199433]],\n        ID[\&quot;EPSG\&quot;,4326]],\n    CONVERSION[\&quot;Transverse Mercator\&quot;,\n        METHOD[\&quot;Transverse Mercator\&quot;,\n            ID[\&quot;EPSG\&quot;,9807]],\n        PARAMETER[\&quot;Latitude of natural origin\&quot;,0,\n            ANGLEUNIT[\&quot;degree\&quot;,0.0174532925199433],\n            ID[\&quot;EPSG\&quot;,8801]],\n        PARAMETER[\&quot;Longitude of natural origin\&quot;,19,\n            ANGLEUNIT[\&quot;degree\&quot;,0.0174532925199433],\n            ID[\&quot;EPSG\&quot;,8802]],\n        PARAMETER[\&quot;Scale factor at natural origin\&quot;,1,\n            SCALEUNIT[\&quot;unity\&quot;,1],\n            ID[\&quot;EPSG\&quot;,8805]],\n        PARAMETER[\&quot;False easting\&quot;,0,\n            LENGTHUNIT[\&quot;metre\&quot;,1],\n            ID[\&quot;EPSG\&quot;,8806]],\n        PARAMETER[\&quot;False northing\&quot;,0,\n            LENGTHUNIT[\&quot;metre\&quot;,1],\n            ID[\&quot;EPSG\&quot;,8807]]],\n    CS[Cartesian,2],\n        AXIS[\&quot;easting\&quot;,east,\n            ORDER[1],\n            LENGTHUNIT[\&quot;metre\&quot;,1,\n                ID[\&quot;EPSG\&quot;,9001]]],\n        AXIS[\&quot;northing\&quot;,north,\n            ORDER[2],\n            LENGTHUNIT[\&quot;metre\&quot;,1,\n                ID[\&quot;EPSG\&quot;,9001]]]]&quot;</code></pre>
<p>Messy, but somewhere in there it says “Longitude of natural origin 19” and “Transverse Mercator”…</p>
<p>Similar to <code>st_crs()</code>, you can define a projection using the syntax:</p>
<p><code>crs(your_raster) &lt;- "your_crs"</code>, where the new CRS can be in WKT, and EPSG code, or a PROJ string.</p>
<p>For reprojecting, you use the function <code>project()</code>. We’ll look at it later.</p>
<p><br></p>
</div>
<div id="cropping-1" class="section level2 hasAnchor" number="8.2">
<h2><span class="header-section-number">8.2</span> Cropping<a href="terra.html#cropping-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Ok, before we try to anything with this dataset, let’s think about how big it is… One of the outputs of calling <code>dem</code> was the row reading <code>dimensions : 9902, 6518, 1  (nrow, ncol, nlyr)</code>. Given that we are talking about 10m pixels, this information tells us that the extent of the region is roughly 100km by 65km and that there are ~65 million pixels! No wonder the original file was ~130MB (I reduced the one I shared with you slightly).</p>
<p>While R can handle this, it does become slow when dealing with very large files. There are many ways to improve the efficiency of handling big rasters in R (see <a href="https://www.ecologi.st/post/big-spatial-data/">this slightly dated post for details</a> if you’re interested), but for the purposes of this tutorial we’re going to take the easy option and just crop it to a smaller extent, like so:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="terra.html#cb100-1" tabindex="-1"></a>dem <span class="ot">&lt;-</span> <span class="fu">crop</span>(dem, <span class="fu">ext</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">66642.18</span>, <span class="sc">-</span><span class="fl">44412.18</span>, <span class="sc">-</span><span class="fl">3809853.29</span>, <span class="sc">-</span><span class="fl">3750723.29</span>)))</span></code></pre></div>
<p>Note that the <code>crop()</code> function requires us to pass it an object of class <code>SpatExtent</code>. Just like <code>st_crop()</code> from <em>sf</em>, <code>crop()</code> can derive the extent from another data object.</p>
<p>One silly difference, is that if you pass it the coordinates of the extent manually (as above), you first need to pass it to the <code>ext()</code> function, and they need to follow the order <em>xmin, xmax, ymin, ymax</em> (as opposed to <em>xmin, ymin, xmax, ymax</em> as you do for <code>st_crop()</code>). Keep your eye out for these little differences, because they will trip you up…</p>
<p>Ok, so how big is our dataset now?</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="terra.html#cb101-1" tabindex="-1"></a>dem</span></code></pre></div>
<pre><code>## class       : SpatRaster 
## dimensions  : 5330, 1977, 1  (nrow, ncol, nlyr)
## resolution  : 10, 10  (x, y)
## extent      : -64180, -44410, -3804020, -3750720  (xmin, xmax, ymin, ymax)
## coord. ref. : GCS_WGS_1984 
## source(s)   : memory
## varname     : CoCT_10m 
## name        : 10m_BA 
## min value   :    -15 
## max value   :   1084</code></pre>
<p>…still &gt;10 million pixels…</p>
<p><br></p>
</div>
<div id="aggregating-resampling" class="section level2 hasAnchor" number="8.3">
<h2><span class="header-section-number">8.3</span> Aggregating / Resampling<a href="terra.html#aggregating-resampling" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Do we need 10m data? If your analysis doesn’t need such fine resolution data, you can resample the raster to a larger pixel size, like 30m. The <code>aggregate()</code> function does this very efficiently, like so:</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="terra.html#cb103-1" tabindex="-1"></a>dem30 <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(dem, <span class="at">fact =</span> <span class="dv">3</span>, <span class="at">fun =</span> mean)</span></code></pre></div>
<pre><code>## 
|---------|---------|---------|---------|
=========================================
                                          </code></pre>
<p>Here I’ve told it to aggregate by a factor of 3 (i.e. bin 9 neighbouring pixels (3x3) into one) and to assign the bigger pixel the mean of the 9 original pixels. This obviously results in some data loss, but that can be acceptable, depending on the purpose of your analysis. Note that you can pass just about any function to <code>fun =</code>, like <code>min()</code>, <code>max()</code> or even your own function.</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="terra.html#cb105-1" tabindex="-1"></a>dem30</span></code></pre></div>
<pre><code>## class       : SpatRaster 
## dimensions  : 1777, 659, 1  (nrow, ncol, nlyr)
## resolution  : 30, 30  (x, y)
## extent      : -64180, -44410, -3804030, -3750720  (xmin, xmax, ymin, ymax)
## coord. ref. : GCS_WGS_1984 
## source(s)   : memory
## name        :   10m_BA 
## min value   :  -15.000 
## max value   : 1083.556</code></pre>
<p>Ok, so we’ve reduced the size of the raster by a factor of 9 and only have a little over 1 million pixels to deal with. Much more reasonable! Now let’s have a look at what we’re dealing with.</p>
<p><br></p>
</div>
<div id="basic-plotting-1" class="section level2 hasAnchor" number="8.4">
<h2><span class="header-section-number">8.4</span> Basic plotting<a href="terra.html#basic-plotting-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Now that we’ve reduced the size of the dataset, we can try the base plotting function:</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="terra.html#cb107-1" tabindex="-1"></a><span class="fu">plot</span>(dem30)</span></code></pre></div>
<p><img src="spatial-r_files/figure-html/unnamed-chunk-51-1.png" width="672" /></p>
<p>Or with the <em>Tidyverse</em>…</p>
<p>Note that <code>ggplot()</code> doesn’t accept rasters, so we need to give it a dataframe with <em>x</em> and <em>y</em> columns for the coordinates, and a column containing the values to plot. This is easily done by coercing the raster into a dataframe, like so:</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="terra.html#cb108-1" tabindex="-1"></a><span class="co">#call tidyverse libraries and plot</span></span>
<span id="cb108-2"><a href="terra.html#cb108-2" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb108-3"><a href="terra.html#cb108-3" tabindex="-1"></a>  </span>
<span id="cb108-4"><a href="terra.html#cb108-4" tabindex="-1"></a>dem30 <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>(<span class="at">xy =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb108-5"><a href="terra.html#cb108-5" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-6"><a href="terra.html#cb108-6" tabindex="-1"></a>  <span class="fu">geom_raster</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> <span class="st">`</span><span class="at">10m_BA</span><span class="st">`</span>))</span></code></pre></div>
<p><img src="spatial-r_files/figure-html/unnamed-chunk-52-1.png" width="336" /></p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="terra.html#cb109-1" tabindex="-1"></a><span class="co"># Note that I had to know that the column name for the elevation data is &quot;10m_BA&quot;... and that you need to use ` ` around a variable name when feeding it to a function if it starts with a digit.</span></span></code></pre></div>
<p>Ok, how different does our 30m raster look to the 10m version?</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="terra.html#cb110-1" tabindex="-1"></a>dem <span class="sc">%&gt;%</span></span>
<span id="cb110-2"><a href="terra.html#cb110-2" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(<span class="at">xy =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb110-3"><a href="terra.html#cb110-3" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb110-4"><a href="terra.html#cb110-4" tabindex="-1"></a>  <span class="fu">geom_raster</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> <span class="st">`</span><span class="at">10m_BA</span><span class="st">`</span>))</span></code></pre></div>
<p><img src="spatial-r_files/figure-html/unnamed-chunk-53-1.png" width="336" /></p>
<p>Not noticeably different at this scale!</p>
<p><br></p>
</div>
<div id="disaggregating" class="section level2 hasAnchor" number="8.5">
<h2><span class="header-section-number">8.5</span> Disaggregating<a href="terra.html#disaggregating" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>One way to explore the degree of data loss is to <code>disagg()</code> our 30m DEM back to 10m and then compare it to the original.</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="terra.html#cb111-1" tabindex="-1"></a>dem10 <span class="ot">&lt;-</span> <span class="fu">disagg</span>(dem30, <span class="at">fact =</span> <span class="dv">3</span>, <span class="at">method =</span> <span class="st">&quot;bilinear&quot;</span>)</span></code></pre></div>
<p>Note that I’ve tried to use <em>bilinear interpolation</em> to give it a fair chance of getting nearer the original values. You can google this on your own, but it essentially smooths the data by averaging across neighbouring pixels.</p>
<p>Now, how can I compare my two 10m rasters?</p>
<p><br></p>
</div>
<div id="raster-maths" class="section level2 hasAnchor" number="8.6">
<h2><span class="header-section-number">8.6</span> Raster maths!<a href="terra.html#raster-maths" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The <em>raster</em> and <em>terra</em> packages make this easy, because you can do maths with rasters, treating them as variables in an equation. This means we can explore the data loss by calculating the difference between the original and disaggregated DEMS.</p>
<p>Note that when aggregating you often lose some of the cells along the edges, and that you can’t do raster maths on rasters with different extents… We can fix this by cropping the larger raster with the smaller first.</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="terra.html#cb112-1" tabindex="-1"></a>dem10 <span class="ot">&lt;-</span> <span class="fu">crop</span>(dem10, dem)</span>
<span id="cb112-2"><a href="terra.html#cb112-2" tabindex="-1"></a></span>
<span id="cb112-3"><a href="terra.html#cb112-3" tabindex="-1"></a>diff <span class="ot">&lt;-</span> dem <span class="sc">-</span> dem10 <span class="co">#maths with rasters!</span></span></code></pre></div>
<p>And plot the result!</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="terra.html#cb113-1" tabindex="-1"></a>diff <span class="sc">%&gt;%</span></span>
<span id="cb113-2"><a href="terra.html#cb113-2" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(<span class="at">xy =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb113-3"><a href="terra.html#cb113-3" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb113-4"><a href="terra.html#cb113-4" tabindex="-1"></a>  <span class="fu">geom_raster</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> <span class="st">`</span><span class="at">10m_BA</span><span class="st">`</span>)) </span></code></pre></div>
<p><img src="spatial-r_files/figure-html/unnamed-chunk-56-1.png" width="336" /></p>
<p>If you look <em>really</em> closely, you’ll see the outline of the cliffs of Table Mountain, where you’d expect the data loss to be worst. The colour ramp tells us that the worst distortion was up to 100m, or about 10% of the elevation range in this dataset, but don’t be fooled by the extremes! Let’s have a look at all the values as a histogram.</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="terra.html#cb114-1" tabindex="-1"></a>diff <span class="sc">%&gt;%</span></span>
<span id="cb114-2"><a href="terra.html#cb114-2" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(<span class="at">xy =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb114-3"><a href="terra.html#cb114-3" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb114-4"><a href="terra.html#cb114-4" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="st">`</span><span class="at">10m_BA</span><span class="st">`</span>))</span></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="spatial-r_files/figure-html/unnamed-chunk-57-1.png" width="672" /></p>
<p>Looks like most values are within 10 or so metres of their original values, so the data loss really wasn’t that bad!</p>
<p><br></p>
</div>
<div id="focal-and-terrain-calculations" class="section level2 hasAnchor" number="8.7">
<h2><span class="header-section-number">8.7</span> Focal and terrain calculations<a href="terra.html#focal-and-terrain-calculations" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In addition to maths with multiple rasters, you can do all kinds of calculations within a raster using <code>focal()</code>. This essentially applies a moving window, calculating values for a neighbourhood of cells as it goes, using whatever function you supply (mean, max, your own, etc).</p>
<p>The function <code>terrain()</code> is a special case of <code>focal()</code>, optimized for calculating <em>slope, aspect, topographic position index (TPI), topographic roughness index (TRI), roughness, or flow direction</em>.</p>
<p>Here I’ll calculate the slope and aspect so that we can pass them to the function <code>shade()</code> to make a pretty hillshade layer.</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="terra.html#cb116-1" tabindex="-1"></a>aspect <span class="ot">&lt;-</span> <span class="fu">terrain</span>(dem30, <span class="st">&quot;aspect&quot;</span>, <span class="at">unit =</span> <span class="st">&quot;radians&quot;</span>)</span>
<span id="cb116-2"><a href="terra.html#cb116-2" tabindex="-1"></a></span>
<span id="cb116-3"><a href="terra.html#cb116-3" tabindex="-1"></a>slope <span class="ot">&lt;-</span> <span class="fu">terrain</span>(dem30, <span class="st">&quot;slope&quot;</span>, <span class="at">unit =</span> <span class="st">&quot;radians&quot;</span>)</span>
<span id="cb116-4"><a href="terra.html#cb116-4" tabindex="-1"></a></span>
<span id="cb116-5"><a href="terra.html#cb116-5" tabindex="-1"></a>hillshade <span class="ot">&lt;-</span> <span class="fu">shade</span>(slope, aspect)</span>
<span id="cb116-6"><a href="terra.html#cb116-6" tabindex="-1"></a></span>
<span id="cb116-7"><a href="terra.html#cb116-7" tabindex="-1"></a><span class="fu">plot</span>(hillshade)</span></code></pre></div>
<p><img src="spatial-r_files/figure-html/unnamed-chunk-58-1.png" width="672" /></p>
<p>Probably prettier with <em>Tidyverse</em>:</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="terra.html#cb117-1" tabindex="-1"></a>hillshade <span class="sc">%&gt;%</span></span>
<span id="cb117-2"><a href="terra.html#cb117-2" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(<span class="at">xy =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb117-3"><a href="terra.html#cb117-3" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb117-4"><a href="terra.html#cb117-4" tabindex="-1"></a>  <span class="fu">geom_raster</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> hillshade)) <span class="sc">+</span> <span class="co">#note that the hillshade column name in this case is &quot;hillshade&quot;</span></span>
<span id="cb117-5"><a href="terra.html#cb117-5" tabindex="-1"></a>  <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="st">&quot;grey10&quot;</span>, <span class="at">high =</span> <span class="st">&quot;grey90&quot;</span>)</span></code></pre></div>
<p><img src="spatial-r_files/figure-html/unnamed-chunk-59-1.png" width="336" /></p>
<p>Nice ne?</p>
<p><br></p>
</div>
<div id="raster-stacks" class="section level2 hasAnchor" number="8.8">
<h2><span class="header-section-number">8.8</span> Raster stacks<a href="terra.html#raster-stacks" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Another nice thing about rasters is that if you have multiple rasters “on the same grid” (i.e. with the same pixel size, extent and CRS) then you can stack them and work with them as a single object. <code>library(raster)</code> users will be familiar with <code>stack()</code>, but in <em>terra</em> you just use the base function <code>c()</code>, like so:</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="terra.html#cb118-1" tabindex="-1"></a>dstack <span class="ot">&lt;-</span> <span class="fu">c</span>(dem30, slope, aspect, hillshade)</span>
<span id="cb118-2"><a href="terra.html#cb118-2" tabindex="-1"></a></span>
<span id="cb118-3"><a href="terra.html#cb118-3" tabindex="-1"></a>dstack</span></code></pre></div>
<pre><code>## class       : SpatRaster 
## dimensions  : 1777, 659, 4  (nrow, ncol, nlyr)
## resolution  : 30, 30  (x, y)
## extent      : -64180, -44410, -3804030, -3750720  (xmin, xmax, ymin, ymax)
## coord. ref. : GCS_WGS_1984 
## source(s)   : memory
## names       :   10m_BA,    slope,   aspect,  hillshade 
## min values  :  -15.000, 0.000000, 0.000000, -0.4906481 
## max values  : 1083.556, 1.370826, 6.283185,  0.9999974</code></pre>
<p>As you can see the “dimensions” now report 4 layers, and there are 4 names. Some of the names don’t look all that informative though, so let’s rename them.</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="terra.html#cb120-1" tabindex="-1"></a><span class="fu">names</span>(dstack) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;elevation&quot;</span>, <span class="st">&quot;slope&quot;</span>, <span class="st">&quot;aspect&quot;</span>, <span class="st">&quot;shade&quot;</span>)</span></code></pre></div>
<p><br></p>
</div>
<div id="extracting-raster-to-vector" class="section level2 hasAnchor" number="8.9">
<h2><span class="header-section-number">8.9</span> Extracting raster to vector<a href="terra.html#extracting-raster-to-vector" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Ok, enough fooling around. More often than not, we just want to extract data from rasters for further analyses (e.g. climate layers, etc), so let’s cover that base here.</p>
<p><br></p>
<p><strong>Extract to points</strong></p>
<p>First, let’s get some points for two species in the Proteaceae, <em>Protea cynaroides</em> and <em>Leucadendron laureolum</em>…</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="terra.html#cb121-1" tabindex="-1"></a><span class="fu">library</span>(rinat)</span>
<span id="cb121-2"><a href="terra.html#cb121-2" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb121-3"><a href="terra.html#cb121-3" tabindex="-1"></a></span>
<span id="cb121-4"><a href="terra.html#cb121-4" tabindex="-1"></a><span class="co">#Call data for two species directly from iNat</span></span>
<span id="cb121-5"><a href="terra.html#cb121-5" tabindex="-1"></a>pc <span class="ot">&lt;-</span> <span class="fu">get_inat_obs</span>(<span class="at">taxon_name =</span> <span class="st">&quot;Protea cynaroides&quot;</span>,</span>
<span id="cb121-6"><a href="terra.html#cb121-6" tabindex="-1"></a>                   <span class="at">bounds =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">35</span>, <span class="dv">18</span>, <span class="sc">-</span><span class="fl">33.5</span>, <span class="fl">18.5</span>),</span>
<span id="cb121-7"><a href="terra.html#cb121-7" tabindex="-1"></a>                   <span class="at">maxresults =</span> <span class="dv">1000</span>)</span>
<span id="cb121-8"><a href="terra.html#cb121-8" tabindex="-1"></a></span>
<span id="cb121-9"><a href="terra.html#cb121-9" tabindex="-1"></a>ll <span class="ot">&lt;-</span> <span class="fu">get_inat_obs</span>(<span class="at">taxon_name =</span> <span class="st">&quot;Leucadendron laureolum&quot;</span>,</span>
<span id="cb121-10"><a href="terra.html#cb121-10" tabindex="-1"></a>                   <span class="at">bounds =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">35</span>, <span class="dv">18</span>, <span class="sc">-</span><span class="fl">33.5</span>, <span class="fl">18.5</span>),</span>
<span id="cb121-11"><a href="terra.html#cb121-11" tabindex="-1"></a>                   <span class="at">maxresults =</span> <span class="dv">1000</span>)</span>
<span id="cb121-12"><a href="terra.html#cb121-12" tabindex="-1"></a></span>
<span id="cb121-13"><a href="terra.html#cb121-13" tabindex="-1"></a><span class="co">#Combine the records into one dataframe</span></span>
<span id="cb121-14"><a href="terra.html#cb121-14" tabindex="-1"></a>pc <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pc,ll)</span>
<span id="cb121-15"><a href="terra.html#cb121-15" tabindex="-1"></a></span>
<span id="cb121-16"><a href="terra.html#cb121-16" tabindex="-1"></a><span class="co">#Filter returned observations by a range of attribute criteria</span></span>
<span id="cb121-17"><a href="terra.html#cb121-17" tabindex="-1"></a>pc <span class="ot">&lt;-</span> pc <span class="sc">%&gt;%</span> <span class="fu">filter</span>(positional_accuracy<span class="sc">&lt;</span><span class="dv">46</span> <span class="sc">&amp;</span> </span>
<span id="cb121-18"><a href="terra.html#cb121-18" tabindex="-1"></a>                latitude<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">&amp;</span></span>
<span id="cb121-19"><a href="terra.html#cb121-19" tabindex="-1"></a>                <span class="sc">!</span><span class="fu">is.na</span>(latitude) <span class="sc">&amp;</span></span>
<span id="cb121-20"><a href="terra.html#cb121-20" tabindex="-1"></a>                captive_cultivated <span class="sc">==</span> <span class="st">&quot;false&quot;</span> <span class="sc">&amp;</span></span>
<span id="cb121-21"><a href="terra.html#cb121-21" tabindex="-1"></a>                quality_grade <span class="sc">==</span> <span class="st">&quot;research&quot;</span>)</span>
<span id="cb121-22"><a href="terra.html#cb121-22" tabindex="-1"></a></span>
<span id="cb121-23"><a href="terra.html#cb121-23" tabindex="-1"></a><span class="co">#Make the dataframe a spatial object of class = &quot;sf&quot;</span></span>
<span id="cb121-24"><a href="terra.html#cb121-24" tabindex="-1"></a>pc <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(pc, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;longitude&quot;</span>, <span class="st">&quot;latitude&quot;</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb121-25"><a href="terra.html#cb121-25" tabindex="-1"></a></span>
<span id="cb121-26"><a href="terra.html#cb121-26" tabindex="-1"></a><span class="co">#Set to the same projection as the elevation data</span></span>
<span id="cb121-27"><a href="terra.html#cb121-27" tabindex="-1"></a>pc <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(pc, <span class="fu">crs</span>(dem30))</span></code></pre></div>
<p>Now let’s extract the data to the points.</p>
<p>NOTE!!! <em>terra</em> doesn’t play nicely with <em>sf</em> objects at this stage, so you need to coerce them into <em>terra’s</em> own vector format using <code>vect()</code>.</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="terra.html#cb122-1" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">extract</span>(dem30, <span class="fu">vect</span>(pc)) <span class="co"># note vect()</span></span>
<span id="cb122-2"><a href="terra.html#cb122-2" tabindex="-1"></a></span>
<span id="cb122-3"><a href="terra.html#cb122-3" tabindex="-1"></a><span class="fu">head</span>(dat)</span></code></pre></div>
<pre><code>##   ID    10m_BA
## 1  1 1024.5556
## 2  2 1052.1111
## 3  3  528.6667
## 4  4  530.8889
## 5  5 1014.4444
## 6  6 1062.4444</code></pre>
<p>Nice, but not all that handy on it’s own. Let’s add the elevation column to our points layer, so we can match it with the species names and plot.</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="terra.html#cb124-1" tabindex="-1"></a>pc<span class="sc">$</span>dem <span class="ot">&lt;-</span> dat<span class="sc">$</span><span class="st">`</span><span class="at">10m_BA</span><span class="st">`</span></span>
<span id="cb124-2"><a href="terra.html#cb124-2" tabindex="-1"></a></span>
<span id="cb124-3"><a href="terra.html#cb124-3" tabindex="-1"></a>pc <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb124-4"><a href="terra.html#cb124-4" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(scientific_name, dem))</span></code></pre></div>
<p><img src="spatial-r_files/figure-html/pc_dem_boxplot-1.png" width="672" /></p>
<p>A clear separation in the preferred elevation range between the two species.</p>
<p><br></p>
<p>Ok, that’s handy, but what if we have data lots of rasters? We don’t want to have to do that for every raster! This is where raster stacks come into their own!</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="terra.html#cb125-1" tabindex="-1"></a><span class="co">#extract from stack</span></span>
<span id="cb125-2"><a href="terra.html#cb125-2" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">extract</span>(dstack, <span class="fu">vect</span>(pc)) </span>
<span id="cb125-3"><a href="terra.html#cb125-3" tabindex="-1"></a></span>
<span id="cb125-4"><a href="terra.html#cb125-4" tabindex="-1"></a><span class="co">#bind columns to points to match the names</span></span>
<span id="cb125-5"><a href="terra.html#cb125-5" tabindex="-1"></a>edat <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">as.data.frame</span>(pc), dat)</span>
<span id="cb125-6"><a href="terra.html#cb125-6" tabindex="-1"></a></span>
<span id="cb125-7"><a href="terra.html#cb125-7" tabindex="-1"></a><span class="co">#select columns we want and tidy data into long format</span></span>
<span id="cb125-8"><a href="terra.html#cb125-8" tabindex="-1"></a>edat <span class="ot">&lt;-</span> edat <span class="sc">%&gt;%</span> </span>
<span id="cb125-9"><a href="terra.html#cb125-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(scientific_name, elevation, slope, aspect, shade) <span class="sc">%&gt;%</span> </span>
<span id="cb125-10"><a href="terra.html#cb125-10" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">c</span>(elevation, slope, aspect, shade))</span>
<span id="cb125-11"><a href="terra.html#cb125-11" tabindex="-1"></a></span>
<span id="cb125-12"><a href="terra.html#cb125-12" tabindex="-1"></a><span class="co">#panel boxplot of the variables extracted</span></span>
<span id="cb125-13"><a href="terra.html#cb125-13" tabindex="-1"></a>edat <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb125-14"><a href="terra.html#cb125-14" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(scientific_name, value)) <span class="sc">+</span></span>
<span id="cb125-15"><a href="terra.html#cb125-15" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>name, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>) </span></code></pre></div>
<p><img src="spatial-r_files/figure-html/stack_boxplot-1.png" width="672" /></p>
<p><br></p>
<p>Something I should have mentioned is that if you would like each point to sample a larger region you can add a <code>buffer =</code> argument to the <code>extract()</code> function, and a function (<code>fun =</code>) to summarize the neighbourhood of pixels sampled, like so:</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="terra.html#cb126-1" tabindex="-1"></a>pc<span class="sc">$</span>dem30 <span class="ot">&lt;-</span> <span class="fu">extract</span>(dem30, <span class="fu">vect</span>(pc), <span class="at">buffer =</span> <span class="dv">200</span>, <span class="at">fun =</span> mean)<span class="sc">$</span><span class="st">`</span><span class="at">10m_BA</span><span class="st">`</span> <span class="co">#Note the sneaky use of $ to access the column I want</span></span>
<span id="cb126-2"><a href="terra.html#cb126-2" tabindex="-1"></a></span>
<span id="cb126-3"><a href="terra.html#cb126-3" tabindex="-1"></a>pc <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb126-4"><a href="terra.html#cb126-4" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(scientific_name, dem30))</span></code></pre></div>
<p><img src="spatial-r_files/figure-html/protea_dem_boxplot-1.png" width="672" /></p>
<p><strong>Extract to polygons</strong></p>
<p>Now let’s try that with our vegetation polygons.</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="terra.html#cb127-1" tabindex="-1"></a><span class="co">#Get historical vegetation layer</span></span>
<span id="cb127-2"><a href="terra.html#cb127-2" tabindex="-1"></a>veg <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">&quot;data/cape_peninsula/veg/Vegetation_Indigenous.shp&quot;</span>)</span></code></pre></div>
<pre><code>## Reading layer `Vegetation_Indigenous&#39; from data source 
##   `/Users/jasper/GIT/spatial-r/data/cape_peninsula/veg/Vegetation_Indigenous.shp&#39; 
##   using driver `ESRI Shapefile&#39;
## Simple feature collection with 1325 features and 5 fields
## Geometry type: POLYGON
## Dimension:     XY
## Bounding box:  xmin: -63972.95 ymin: -3803535 xmax: 430.8125 ymax: -3705149
## Projected CRS: WGS_1984_Transverse_Mercator</code></pre>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="terra.html#cb129-1" tabindex="-1"></a><span class="co">#Crop to same extent as DEM</span></span>
<span id="cb129-2"><a href="terra.html#cb129-2" tabindex="-1"></a>veg <span class="ot">&lt;-</span> <span class="fu">st_crop</span>(veg, <span class="fu">ext</span>(dem30)) <span class="co">#Note that I just fed it the extent of the DEM</span></span></code></pre></div>
<pre><code>## Warning: attribute variables are assumed to be spatially constant throughout all geometries</code></pre>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="terra.html#cb131-1" tabindex="-1"></a><span class="co">#Best to dissolve polygons first - otherwise you get repeat outputs for each polygon within each veg type</span></span>
<span id="cb131-2"><a href="terra.html#cb131-2" tabindex="-1"></a>vegsum <span class="ot">&lt;-</span> veg <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(National_) <span class="sc">%&gt;%</span> </span>
<span id="cb131-3"><a href="terra.html#cb131-3" tabindex="-1"></a>  <span class="fu">summarize</span>()</span>
<span id="cb131-4"><a href="terra.html#cb131-4" tabindex="-1"></a></span>
<span id="cb131-5"><a href="terra.html#cb131-5" tabindex="-1"></a><span class="co">#Do extraction - note the summary function</span></span>
<span id="cb131-6"><a href="terra.html#cb131-6" tabindex="-1"></a>vegdem <span class="ot">&lt;-</span> <span class="fu">extract</span>(dem30, <span class="fu">vect</span>(vegsum), <span class="at">fun =</span> mean, <span class="at">na.rm =</span> T)</span></code></pre></div>
<pre><code>## Warning: [extract] transforming vector data to the CRS of the raster</code></pre>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="terra.html#cb133-1" tabindex="-1"></a><span class="co">#Combine the names and vector extracted means into a dataframe</span></span>
<span id="cb133-2"><a href="terra.html#cb133-2" tabindex="-1"></a>vegdem <span class="ot">&lt;-</span> <span class="fu">cbind</span>(vegdem, vegsum<span class="sc">$</span>National_)</span>
<span id="cb133-3"><a href="terra.html#cb133-3" tabindex="-1"></a></span>
<span id="cb133-4"><a href="terra.html#cb133-4" tabindex="-1"></a><span class="co">#Rename the columns to something meaningful</span></span>
<span id="cb133-5"><a href="terra.html#cb133-5" tabindex="-1"></a><span class="fu">names</span>(vegdem) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;ID&quot;</span>, <span class="st">&quot;Mean elevation (m)&quot;</span>, <span class="st">&quot;Vegetation type&quot;</span>)</span>
<span id="cb133-6"><a href="terra.html#cb133-6" tabindex="-1"></a></span>
<span id="cb133-7"><a href="terra.html#cb133-7" tabindex="-1"></a><span class="co">#Plot</span></span>
<span id="cb133-8"><a href="terra.html#cb133-8" tabindex="-1"></a>vegdem <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb133-9"><a href="terra.html#cb133-9" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="st">`</span><span class="at">Mean elevation (m)</span><span class="st">`</span>, <span class="at">x =</span> <span class="st">`</span><span class="at">Vegetation type</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb133-10"><a href="terra.html#cb133-10" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust=</span><span class="dv">1</span>))</span></code></pre></div>
<p><img src="spatial-r_files/figure-html/dem_hist-1.png" width="672" /></p>
<p>Ok, I did a lot of things there…, but you get it right? Note that I applied a function to the <code>extract()</code> to summarize the output, because each polygon usually returns multiple raster cell values. You can choose (or code up) your own function.</p>
<p><br></p>
<p>Here’s a different approach…</p>
<p><br></p>
</div>
<div id="rasterizing" class="section level2 hasAnchor" number="8.10">
<h2><span class="header-section-number">8.10</span> Rasterizing<a href="terra.html#rasterizing" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><em>Rasterizing</em> essentially means turning a vector layer into a raster. To rasterize, you need an existing raster grid to rasterize to, like <code>dem30</code> in this case.</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="terra.html#cb134-1" tabindex="-1"></a><span class="co">#Make the vegetation type a factor</span></span>
<span id="cb134-2"><a href="terra.html#cb134-2" tabindex="-1"></a>vegsum<span class="sc">$</span>National_ <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(vegsum<span class="sc">$</span>National_)</span>
<span id="cb134-3"><a href="terra.html#cb134-3" tabindex="-1"></a></span>
<span id="cb134-4"><a href="terra.html#cb134-4" tabindex="-1"></a><span class="co">#Rasterize</span></span>
<span id="cb134-5"><a href="terra.html#cb134-5" tabindex="-1"></a>vegras <span class="ot">&lt;-</span> <span class="fu">rasterize</span>(<span class="fu">vect</span>(vegsum), dem30, <span class="at">field =</span> <span class="st">&quot;National_&quot;</span>)</span>
<span id="cb134-6"><a href="terra.html#cb134-6" tabindex="-1"></a></span>
<span id="cb134-7"><a href="terra.html#cb134-7" tabindex="-1"></a><span class="co">#Plot</span></span>
<span id="cb134-8"><a href="terra.html#cb134-8" tabindex="-1"></a>vegras <span class="sc">%&gt;%</span> </span>
<span id="cb134-9"><a href="terra.html#cb134-9" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(<span class="at">xy =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb134-10"><a href="terra.html#cb134-10" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb134-11"><a href="terra.html#cb134-11" tabindex="-1"></a>  <span class="fu">geom_raster</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> National_))</span></code></pre></div>
<p><img src="spatial-r_files/figure-html/penviz-1.png" width="528" /></p>
<p>I’m sure this plot is a surprise to those who worked with <em>raster</em>. Usually rasters want to work with numbers. <em>terra</em> can work with (and rasterize) data of class “factor”, opening up all kinds of opportunities.</p>
<p><br></p>
<p>But once you have a raster of class factor and a raster with values, you can stack and unpack them into a dataframe and analyse them as you would usually.</p>
<p><br></p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="terra.html#cb135-1" tabindex="-1"></a><span class="co">#Stack the two rasters</span></span>
<span id="cb135-2"><a href="terra.html#cb135-2" tabindex="-1"></a>vegdem <span class="ot">&lt;-</span> <span class="fu">c</span>(vegras, dem30) </span>
<span id="cb135-3"><a href="terra.html#cb135-3" tabindex="-1"></a></span>
<span id="cb135-4"><a href="terra.html#cb135-4" tabindex="-1"></a><span class="co">#Convert to data frame</span></span>
<span id="cb135-5"><a href="terra.html#cb135-5" tabindex="-1"></a>vegdem_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(vegdem) </span>
<span id="cb135-6"><a href="terra.html#cb135-6" tabindex="-1"></a></span>
<span id="cb135-7"><a href="terra.html#cb135-7" tabindex="-1"></a><span class="co">#Plot</span></span>
<span id="cb135-8"><a href="terra.html#cb135-8" tabindex="-1"></a>vegdem_df <span class="sc">%&gt;%</span> </span>
<span id="cb135-9"><a href="terra.html#cb135-9" tabindex="-1"></a>  <span class="fu">group_by</span>(National_) <span class="sc">%&gt;%</span></span>
<span id="cb135-10"><a href="terra.html#cb135-10" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="st">`</span><span class="at">Mean elevation (m)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean</span>(<span class="st">`</span><span class="at">10m_BA</span><span class="st">`</span>, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span></span>
<span id="cb135-11"><a href="terra.html#cb135-11" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb135-12"><a href="terra.html#cb135-12" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="st">`</span><span class="at">Mean elevation (m)</span><span class="st">`</span>, <span class="at">x =</span> <span class="st">`</span><span class="at">National_</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb135-13"><a href="terra.html#cb135-13" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust=</span><span class="dv">1</span>))</span></code></pre></div>
<p><img src="spatial-r_files/figure-html/unnamed-chunk-63-1.png" width="672" /></p>
<p><br></p>
<p>Tadaa! Same figure we made before, but we took a different route this time. The ability to turn stacked rasters into dataframes and analyse them “non-spatially” can be very powerful. There are also a bunch of functions that make this even easier.</p>
<p><br></p>
</div>
<div id="crosstabulating-rasters" class="section level2 hasAnchor" number="8.11">
<h2><span class="header-section-number">8.11</span> Crosstabulating rasters<a href="terra.html#crosstabulating-rasters" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Say we had two rasters that each contained factor data (i.e. discrete) and we wanted to look at the frequency of associations between the two sets of classes? We can very easily do this with the function <code>crosstab()</code>.</p>
<p>Here’s an example looking at slope classes by vegetation type. First, we classify our slope raster into discrete classes, then we cross-tabulate the classified slope raster with our raster of vegetation types.</p>
<p><br></p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="terra.html#cb136-1" tabindex="-1"></a><span class="co"># Classify the slope raster into 5 classes</span></span>
<span id="cb136-2"><a href="terra.html#cb136-2" tabindex="-1"></a>slopeclass <span class="ot">&lt;-</span> <span class="fu">classify</span>(slope, <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.3</span>, <span class="fl">0.6</span>, <span class="fl">0.9</span>, <span class="fl">1.2</span>, <span class="fl">1.4</span>), <span class="at">include.lowest=</span><span class="cn">TRUE</span>)</span>
<span id="cb136-3"><a href="terra.html#cb136-3" tabindex="-1"></a></span>
<span id="cb136-4"><a href="terra.html#cb136-4" tabindex="-1"></a><span class="fu">plot</span>(slopeclass)</span></code></pre></div>
<p><img src="spatial-r_files/figure-html/unnamed-chunk-64-1.png" width="672" /></p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="terra.html#cb137-1" tabindex="-1"></a><span class="co"># Crosstabulate slope with veg type</span></span>
<span id="cb137-2"><a href="terra.html#cb137-2" tabindex="-1"></a><span class="fu">crosstab</span>(<span class="fu">c</span>(vegras, slopeclass))</span></code></pre></div>
<pre><code>##                                          slope
## National_                                 (0.3–0.6] (0.6–0.9] (0.9–1.2] (1.2–1.4] [0–0.3]
##   Beach - FalseBay                              360       165        40         0    2607
##   Cape Estuarine Salt Marshes                     0         0         0         0     123
##   Cape Flats Dune Strandveld - False Bay       2890       820       101         0   41433
##   Cape Flats Dune Strandveld - West Coast         0         0         0         0    7162
##   Cape Flats Sand Fynbos                          3         0         0         0  108940
##   Cape Lowland Freshwater Wetlands                0         0         0         0    6604
##   Hangklip Sand Fynbos                         2819       141         8         0   33647
##   Peninsula Granite Fynbos - North            11037       508         8         0   11445
##   Peninsula Granite Fynbos - South            13425      2079       335        16   63627
##   Peninsula Sandstone Fynbos                  58525     20674      4167       191  160146
##   Peninsula Shale Fynbos                       2989       340        45         0   10660
##   Peninsula Shale Renosterveld                 2441        67         0         0   23969
##   RECLAIMED                                      36         3         0         0    6436
##   Southern Afrotemperate Forest                1748       483        78         3    1534</code></pre>
<p><br></p>
<p>This function is particularly useful for something like comparing land cover datasets from 2 time points. Also have a look at <code>freq</code> and <code>zonal</code>.</p>
<p><br></p>
</div>
<div id="visualizing-multiple-datasets-on-one-map" class="section level2 hasAnchor" number="8.12">
<h2><span class="header-section-number">8.12</span> Visualizing multiple datasets on one map<a href="terra.html#visualizing-multiple-datasets-on-one-map" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>What about if we want to plot multiple datasets on one map?</p>
<p>This is easy, if you can feed each dataset into a separate ggplot function. Here’s the veg types with contours and the iNaturalist records we retrieved earlier.</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="terra.html#cb139-1" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb139-2"><a href="terra.html#cb139-2" tabindex="-1"></a>  <span class="fu">geom_raster</span>(<span class="at">data =</span> <span class="fu">as.data.frame</span>(vegras, <span class="at">xy =</span> <span class="cn">TRUE</span>),</span>
<span id="cb139-3"><a href="terra.html#cb139-3" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> National_)) <span class="sc">+</span></span>
<span id="cb139-4"><a href="terra.html#cb139-4" tabindex="-1"></a>  <span class="fu">geom_contour</span>(<span class="at">data =</span> <span class="fu">as.data.frame</span>(dem30, <span class="at">xy =</span> <span class="cn">TRUE</span>), </span>
<span id="cb139-5"><a href="terra.html#cb139-5" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">z =</span> <span class="st">`</span><span class="at">10m_BA</span><span class="st">`</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1100</span>, <span class="dv">100</span>), <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>) <span class="sc">+</span></span>
<span id="cb139-6"><a href="terra.html#cb139-6" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data=</span>pc, <span class="at">colour =</span> <span class="st">&quot;white&quot;</span>, <span class="at">size =</span> <span class="fl">0.5</span>)</span></code></pre></div>
<p><img src="spatial-r_files/figure-html/penviz_multi-1.png" width="576" /></p>
<p>For more inspiration on mapping with R, check out <a href="https://slingsby-maps.myshopify.com/" class="uri">https://slingsby-maps.myshopify.com/</a>. I’ve been generating the majority of the basemap (terrain colour, hillshade, contours, streams, etc) for these in R for the past few years.</p>
<p><br></p>
</div>
<div id="cloud-optimized-geotiffs-cogs" class="section level2 hasAnchor" number="8.13">
<h2><span class="header-section-number">8.13</span> Cloud Optimized GeoTiffs (COGs)!!!<a href="terra.html#cloud-optimized-geotiffs-cogs" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>I thought I’d add this as a bonus section, reinforcing the value of standardized open metadata and file formats from the <a href="https://www.ecologi.st/data-management/data.html#describe">Data Management</a> module.</p>
<p>First, let’s open a connection to our COG, which is stored in the cloud. To do this, we need to pass a URL to the file’s online location to <em>terra</em>.</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="terra.html#cb140-1" tabindex="-1"></a>cog.url <span class="ot">&lt;-</span> <span class="st">&quot;/vsicurl/https://mnemosyne.somisana.ac.za/osgeo/saeon_rgb/grootbos.tif&quot;</span></span>
<span id="cb140-2"><a href="terra.html#cb140-2" tabindex="-1"></a></span>
<span id="cb140-3"><a href="terra.html#cb140-3" tabindex="-1"></a>grootbos <span class="ot">&lt;-</span> <span class="fu">rast</span>(cog.url)</span>
<span id="cb140-4"><a href="terra.html#cb140-4" tabindex="-1"></a></span>
<span id="cb140-5"><a href="terra.html#cb140-5" tabindex="-1"></a>grootbos</span></code></pre></div>
<pre><code>## class       : SpatRaster 
## dimensions  : 100024, 121627, 3  (nrow, ncol, nlyr)
## resolution  : 0.08, 0.08  (x, y)
## extent      : 35640.41, 45370.57, -3828176, -3820175  (xmin, xmax, ymin, ymax)
## coord. ref. : LO19 
## source      : grootbos.tif 
## colors RGB  : 1, 2, 3 
## names       : grootbos_1, grootbos_2, grootbos_3</code></pre>
<p>This has given us the metadata about the file, but has not read it into R’s memory. The file is ~1.8GB so it would do bad things if we tried to read the whole thing in…</p>
<p>Now let’s retrieve a subset of the file. To do this we need to make a vector polygon for our region of interest (ROI), like so:</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="terra.html#cb142-1" tabindex="-1"></a>roi <span class="ot">&lt;-</span> <span class="fu">vect</span>(<span class="fu">data.frame</span>(<span class="at">lon =</span> <span class="fu">c</span>(<span class="fl">19.433975</span>, <span class="fl">19.436451</span>),</span>
<span id="cb142-2"><a href="terra.html#cb142-2" tabindex="-1"></a>                       <span class="at">lat =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">34.522733</span>, <span class="sc">-</span><span class="fl">34.520735</span>)),</span>
<span id="cb142-3"><a href="terra.html#cb142-3" tabindex="-1"></a>            <span class="at">crs =</span> <span class="st">&quot;epsg:4326&quot;</span>)</span></code></pre></div>
<p>And transform it to the same projection as the COG:</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="terra.html#cb143-1" tabindex="-1"></a>roi <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">project</span>(roi, <span class="fu">crs</span>(grootbos))</span></code></pre></div>
<p>And then extract our ROI</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="terra.html#cb144-1" tabindex="-1"></a>roi_ras <span class="ot">&lt;-</span> <span class="fu">crop</span>(grootbos, roi)</span>
<span id="cb144-2"><a href="terra.html#cb144-2" tabindex="-1"></a></span>
<span id="cb144-3"><a href="terra.html#cb144-3" tabindex="-1"></a>roi_ras</span></code></pre></div>
<pre><code>## class       : SpatRaster 
## dimensions  : 2758, 2853, 3  (nrow, ncol, nlyr)
## resolution  : 0.08, 0.08  (x, y)
## extent      : 39845.61, 40073.85, -3821732, -3821512  (xmin, xmax, ymin, ymax)
## coord. ref. : LO19 
## source(s)   : memory
## colors RGB  : 1, 2, 3 
## varname     : grootbos 
## names       : grootbos_1, grootbos_2, grootbos_3 
## min values  :         28,         47,         56 
## max values  :        255,        255,        255</code></pre>
<p>Now we have a raster with 3 layers in memory. There are Red Green and Blue, so we should be able to plot them, like so:</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="terra.html#cb146-1" tabindex="-1"></a><span class="fu">plotRGB</span>(roi_ras)</span></code></pre></div>
<p><img src="spatial-r_files/figure-html/plot_cog-1.png" width="672" /></p>
<p>This somewhat arbitrary looking site is where we did some fieldwork in the Grootbos Private Nature Reserve with the 2022 class…</p>
<p><br></p>
</div>
<div id="obtaining-satellite-data-from-apis" class="section level2 hasAnchor" number="8.14">
<h2><span class="header-section-number">8.14</span> Obtaining satellite data from APIs<a href="terra.html#obtaining-satellite-data-from-apis" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>There are also R packages like <a href="https://cran.r-project.org/web/packages/MODISTools/index.html">MODISTools</a> that allow you to query the online databases.</p>
<p>MODISTools interfaces with the ‘MODIS Land Products Subsets’ Web Services to download various products. In this case we’ll be downloading the “MOD13Q1” product, which is the Vegetation Indices product for the Terra satellite, generated every 16 days at 250 meter (m) spatial resolution. The algorithm chooses the best available pixel value from all (daily) the acquisitions from the 16 day period, minimizing clouds, low view angle, and selecting the highest NDVI/EVI value.</p>
<p>WARNING! This code can take a while to run! Hence, I have wrapped it in an <code>if()</code> statement that tells the code not to run if the file already exists.</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="terra.html#cb147-1" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(<span class="st">&quot;data/MODISdat_batch_30Jan2023.csv&quot;</span>)) <span class="co"># if the file does not exist, then run... otherwise do nothing...</span></span>
<span id="cb147-2"><a href="terra.html#cb147-2" tabindex="-1"></a>  {</span>
<span id="cb147-3"><a href="terra.html#cb147-3" tabindex="-1"></a></span>
<span id="cb147-4"><a href="terra.html#cb147-4" tabindex="-1"></a><span class="fu">library</span>(MODISTools)</span>
<span id="cb147-5"><a href="terra.html#cb147-5" tabindex="-1"></a></span>
<span id="cb147-6"><a href="terra.html#cb147-6" tabindex="-1"></a>sites <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">site_name =</span> <span class="fu">c</span>(<span class="st">&quot;grassy field&quot;</span>, <span class="st">&quot;invasion&quot;</span>, <span class="st">&quot;renosterveld&quot;</span>, <span class="st">&quot;sand&quot;</span>, <span class="st">&quot;sandstone&quot;</span>, <span class="st">&quot;limestone&quot;</span>),</span>
<span id="cb147-7"><a href="terra.html#cb147-7" tabindex="-1"></a>                    <span class="at">lat =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">34.375052</span>, <span class="sc">-</span><span class="fl">34.386014</span>, <span class="sc">-</span><span class="fl">34.374259</span>, <span class="sc">-</span><span class="fl">34.3961</span>, <span class="sc">-</span><span class="fl">34.3748</span>, <span class="sc">-</span><span class="fl">34.4309</span>),</span>
<span id="cb147-8"><a href="terra.html#cb147-8" tabindex="-1"></a>                    <span class="at">lon =</span> <span class="fu">c</span>(<span class="fl">20.531749</span>, <span class="fl">20.534986</span>, <span class="fl">20.504233</span>, <span class="fl">20.5494</span>, <span class="fl">20.5428</span>, <span class="fl">20.5666</span>))</span>
<span id="cb147-9"><a href="terra.html#cb147-9" tabindex="-1"></a></span>
<span id="cb147-10"><a href="terra.html#cb147-10" tabindex="-1"></a><span class="do">### Here&#39;s some code if you want to use an existing layer of points instead of entering them manually</span></span>
<span id="cb147-11"><a href="terra.html#cb147-11" tabindex="-1"></a><span class="co"># sites &lt;- st_read(&quot;/home/jasper/GIT/BIO3018F/prac/Potberg_prac_sites.kml&quot;)</span></span>
<span id="cb147-12"><a href="terra.html#cb147-12" tabindex="-1"></a><span class="co"># sites &lt;- data.frame(site_name = sites$Name, lat = st_coordinates(sites)[,2], lon = st_coordinates(sites)[,1])</span></span>
<span id="cb147-13"><a href="terra.html#cb147-13" tabindex="-1"></a></span>
<span id="cb147-14"><a href="terra.html#cb147-14" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">mt_batch_subset</span>(<span class="at">df =</span> sites,</span>
<span id="cb147-15"><a href="terra.html#cb147-15" tabindex="-1"></a>                        <span class="at">product =</span> <span class="st">&quot;MOD13Q1&quot;</span>,</span>
<span id="cb147-16"><a href="terra.html#cb147-16" tabindex="-1"></a>                        <span class="at">band =</span> <span class="st">&quot;250m_16_days_NDVI&quot;</span>,</span>
<span id="cb147-17"><a href="terra.html#cb147-17" tabindex="-1"></a>                        <span class="at">internal =</span> <span class="cn">TRUE</span>,</span>
<span id="cb147-18"><a href="terra.html#cb147-18" tabindex="-1"></a>                        <span class="at">start =</span> <span class="st">&quot;2000-01-01&quot;</span>,</span>
<span id="cb147-19"><a href="terra.html#cb147-19" tabindex="-1"></a>                        <span class="at">end =</span> <span class="st">&quot;2023-01-30&quot;</span>)</span>
<span id="cb147-20"><a href="terra.html#cb147-20" tabindex="-1"></a></span>
<span id="cb147-21"><a href="terra.html#cb147-21" tabindex="-1"></a><span class="fu">write_csv</span>(dat, <span class="st">&quot;data/MODISdat_batch_30Jan2023.csv&quot;</span>)</span>
<span id="cb147-22"><a href="terra.html#cb147-22" tabindex="-1"></a>}</span></code></pre></div>
<p>Plot all time series</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="terra.html#cb148-1" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="st">&quot;data/MODISdat_batch_30Jan2023.csv&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb148-2"><a href="terra.html#cb148-2" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> calendar_date, <span class="at">y =</span> value<span class="sc">*</span><span class="fl">0.0001</span>)) <span class="sc">+</span></span>
<span id="cb148-3"><a href="terra.html#cb148-3" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb148-4"><a href="terra.html#cb148-4" tabindex="-1"></a>  <span class="co">#  geom_point() +</span></span>
<span id="cb148-5"><a href="terra.html#cb148-5" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(.<span class="sc">~</span> site) <span class="sc">+</span></span>
<span id="cb148-6"><a href="terra.html#cb148-6" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;NDVI&quot;</span>) <span class="sc">+</span></span>
<span id="cb148-7"><a href="terra.html#cb148-7" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fl">0.2</span>, <span class="fl">0.9</span>)</span></code></pre></div>
<p><img src="spatial-r_files/figure-html/modis_plot-1.png" width="672" /></p>
<p>There are many more complex spatial and remote sensing analyses you can do by interaction with the cloud from R. Here are some links to a few:</p>
<ul>
<li><a href="https://r-spatial.org//r/2021/04/23/cloud-based-cubes.html">Cloud-based processing of satellite image collections with <code>rstac</code> and <code>gdalcubes</code></a></li>
<li><a href="https://csaybar.github.io/rgee-examples/">Run Google Earth Engine from R with <code>rgee</code></a></li>
<li><a href="https://kdvdecisions-blog.netlify.app/2020/04/18/obtaining-spatial-data-from-esri-rest-apis-in-r/">Obtain spatial data from ESRI REST APIs in R</a> or see package <a href="https://cran.r-project.org/web/packages/arcpullr/index.html"><code>arcpullr</code></a></li>
</ul>
<p>There are many more!!!</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="rdemo.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="old-raster-gis-operations-in-r-with-raster.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/jslingsby/spatial-r/edit/master/07-terra.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/jslingsby/spatial-r/blob/master/07-terra.Rmd",
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
